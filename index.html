<head>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css"
    integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">

  <!-- Latest compiled and minified JavaScript -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
    integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="styles.css">
  <script>
    function setVoice() {
      var available_voices = window.speechSynthesis.getVoices();
      // this will hold an english voice
      window.english_voice = '';
      // find voice by language locale "en-US"
      // if not then select the first voice
      for (var i = 0; i < available_voices.length; i++) {
        if (available_voices[i].lang === 'en-US') {
          window.english_voice = available_voices[i];
          break;
        }
      }
      if (window.english_voice === '')
        window.english_voice = available_voices[0];
    }

    function setup() {
      setTimeout(() => {
        setVoice()
      }, 2000);
      window.state = {};
    }

    function speak(text) {
      var utter = new SpeechSynthesisUtterance();
      utter.rate = 1;
      utter.pitch = 0.7;
      utter.voice = window.english_voice;
      utter.text = text;
      window.speechSynthesis.speak(utter);
    }

    function main(state) {
      if (!state){
        throw Error("State is undefined. Did you forgt to pass it in?");
      }
      let t = 1000 * Math.random() * (state.max - state.min) + state.min * 1000;

      var sel = document.getElementById("drills");
      var val = sel.options[sel.selectedIndex].value;
      let text;
      if (val === "Day2") {
        text = nextRandomDay2Text();
      } else if (val === "Day3") {
        text = nextRandomDay3Text();
      } else if (val === "Day4a") {
        text = nextRandomDay4ReversalText();
      } else if (val === "Day4b") {
        text = nextRandomDay4RedGreenLightText(state);
      }
      speak(text);
      document.getElementById("display").innerHTML = text;
      console.log(state);
      state.mainLoop = setTimeout(() => main(state), t);
    }

    function start(state) {
      if (!state){
        throw Error("State is undefined. Did you forgt to pass it in?");
      }
      state.min = document.getElementById("min").value;
      state.max = document.getElementById("max").value;
      let dur = parseInt(document.getElementById("dur").value);
      speak("Get ready!");
      document.getElementById("display").innerHTML = "Get Ready!";
      document.getElementById("button").innerHTML = "Stop";
      document.getElementById("button").onclick = () => stop(state);
      state.kill = setTimeout(() => {
        stop(state);
        speak("Time's up! Good Job!");
      }, dur * 1000);
      state.mainLoop = setTimeout(() => main(state), 3000);
    }

    function stop(state) {
      if (!state){
        throw Error("State is undefined. Did you forgt to pass it in?");
      }
      state = clearState(state);
      document.getElementById("display").innerHTML = "Instructions will display here";
      document.getElementById("button").innerHTML = "Start";
      document.getElementById("button").onclick = () => start(state);
    }

    function nextRandomDay2Text() {
      let options = ['Forward', 'Back', 'Left', 'Right', 'Turn Left', 'Turn Right'];
      let index = Math.floor(Math.random() * options.length);
      let text = options[index];
      return text;
    }

    function nextRandomDay3Text() {
      return Math.ceil(Math.random() * 12);
    }

    function nextRandomDay4ReversalText() {
      return "Reverse";
    }

    function nextRandomDay4RedGreenLightText(state) {
      if (!state){
        throw Error("State is undefined. Did you forgt to pass it in?");
      }
      if (state.redGreen === 'Green light') {
        state.redGreen = 'Red light';
        return 'Red light';
      } else {
        state.redGreen = 'Green light';
        return 'Green light';
      }
      return Math.ceil(Math.random() * 12);
    }
    
    function clearState(state){
      if (!state){
        throw Error("State is undefined. Did you forgt to pass it in?");
      }
      if (state.mainLoop){
        clearTimeout(state.mainLoop);        
      }
      if (state.kill) {
        clearTimeout(state.kill);
      }
      return {};
    }
    setup();
  </script>
</head>

<body>
  <div class="container">
    <div class="header clearfix">
      <h3 class="text-muted">SLDM Footwork Agility Drill Randomizer</h3>
    </div>

    <div class="jumbotron">
      <h2>Please select your options</h2>
      <div>
        <label>Min Delay(s)</label>
        <input id="min" type="number" value="2" />
      </div>
      <div>
        <label>Max Delay(s)</label>
        <input id="max" type="number" value="4" />
      </div>
      <div>
        <label>Duration(s)</label>
        <input id="dur" type="number" value="90" />
      </div>
      <div>
        <label>Drill</label>
        <select id="drills">
          <option value="Day2">Day 2 (Different Direcitons)</option>
          <option value="Day3">Day 3 (Hours on the clock)</option>
          <option value="Day4a">Day 4 (Reversals)</option>
          <option value="Day4b">Day 4 (Red/Green Light)</option>
        </select>
      </div>
      <div>
        <p>
          Click to begin!
        </p>
        <button id="button" onclick="start(window.state)">Start</button>
      </div>
      <h4 id="display">Instructions will display here</h4>
    </div>
  </div>
</body>